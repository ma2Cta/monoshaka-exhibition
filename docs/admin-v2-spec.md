# 新管理画面（Admin v2）仕様書

## 概要

ループ再生画面と管理画面を統合した、新しい管理画面の仕様書です。
プレイリストの管理と再生を一つの画面で行えるようにすることで、運用効率を向上させます。

## 目的

- プレイリストの編集中に即座にループ再生でテストできる
- デバイスを指定したループ再生を管理画面から直接実行できる
- UIをコンパクトにし、音声管理に集中できる

## URL構造

既存の `/admin` を残したまま、新しいパスを作成します。

- プレイリスト一覧: `/admin/v2`
- プレイリスト詳細: `/admin/v2/playlists/[id]`

## 画面構成

### プレイリスト一覧画面 (`/admin/v2`)

既存の管理画面と同等の機能を提供します。

#### 機能
- プレイリスト作成フォーム（名前入力 + 作成ボタン）
- プレイリスト一覧テーブル
  - 状態（有効/無効のバッジ）
  - プレイリスト名（クリックで詳細画面へ）
  - 作成日時
  - 操作ボタン（有効化、削除）
- 確認ダイアログ（削除時、有効化時）

#### 技術仕様
- 既存の `PlaylistManager` コンポーネントをそのまま再利用
- ファイルパス: `src/app/admin/v2/page.tsx`

### プレイリスト詳細画面 (`/admin/v2/playlists/[id]`)

プレイリストの管理とループ再生を一つの画面で行います。

#### レイアウト構成

画面は以下の要素で構成されます（上から順に）：

1. **ヘッダー**
   - 戻るボタン
   - プレイリスト名
   - 有効バッジ（is_active: true の場合）
   - 録音数

2. **再生コントロールカード**
   - デバイス選択ドロップダウン
   - 再生/停止ボタン
   - 現在の再生位置（例: "3 / 10"）
   - プログレスバー
   - コンパクトビジュアライザー（150px × 40px）
   - 再生中/一時停止中のステータスバッジ

3. **アクションバー**
   - 音声アップロードボタン（クリックでモーダルを開く）

4. **音声一覧**
   - ドラッグ&ドロップで並び替え
   - 各録音の情報（作成日時、再生時間、文字起こし）
   - 文字起こし機能（生成、編集、保存）
   - 再生/停止ボタン
   - 削除ボタン

#### 機能詳細

##### 再生機能

- **自動ループ再生**: 既存のループ再生画面と同じ動作
  - プレイリストの録音を順番に再生
  - プレイリスト一周後、自動的に新しいプレイリストデータを取得して再開
  - 再生開始時にプレイリストのスナップショットを保持
  - 次のトラックをプリロード（2つのAudio要素を使用）

- **再生中の編集動作**
  - 録音の削除や並び替えを行った場合、現在の再生は継続
  - 変更は次のループから反映される（既存のループ再生画面と同じ挙動）

##### デバイス選択

- 音声出力デバイスを選択可能
- `selectAudioOutput()` APIをサポートするブラウザではネイティブUIを使用
- サポートしていない場合は `enumerateDevices()` で取得したデバイス一覧からドロップダウンで選択
- 選択したデバイスはlocalStorageに保存し、次回起動時に復元

##### ビジュアライザー

- **サイズ**: 150px × 40px（コンパクト）
- **デザイン**: 10本程度の縦棒で構成
- **アニメーション**: 再生中のみ各棒がランダムな速度でパルス
- **配置**: 再生コントロールカード内に表示

##### 音声アップロード

- **UI形式**: モーダル/ダイアログ
- **トリガー**: 「音声アップロード」ボタンをクリック
- **機能**: 既存の `AudioFileUploader` と同等
  - 複数ファイル選択
  - ファイル情報表示（ファイル名、サイズ、再生時間、ステータス）
  - ドラッグ&ドロップで順序変更
  - プレビュー再生
  - 一括アップロード
  - 進捗表示
  - 対応形式: WebM, WAV, MP3, OGG

##### 音声一覧

既存の管理画面と同等の機能を提供します。

- **ドラッグ&ドロップで並び替え**: `@dnd-kit` ライブラリ使用
- **録音情報表示**: 作成日時、再生時間、文字起こし
- **文字起こし機能**:
  - 生成ボタン: `/api/transcribe` APIを呼び出し
  - 編集: テキストエリアで編集可能
  - 再生成: 編集中に再生成ボタンで新しい文字起こしを取得
  - 保存: DBに保存
- **再生/停止**: Audio要素で再生
- **削除**: 個別削除

## 削除した機能

以下の機能は新管理画面では実装しません：

- **プレイリスト統計情報**: 総録音数、総再生時間、本日の録音数、平均再生時間

## 技術仕様

### 新規作成コンポーネント

#### `CompactVisualizer`
- **パス**: `src/components/player/CompactVisualizer.tsx`
- **Props**:
  - `isPlaying: boolean` - 再生中かどうか
- **説明**: 150px × 40px のコンパクトなビジュアライザー

#### `PlaybackControl`
- **パス**: `src/components/admin/PlaybackControl.tsx`
- **Props**:
  - `playlistId: string` - プレイリストID
- **説明**: 再生コントロール、デバイス選択、ビジュアライザーを含むカード

#### `AudioUploadModal`
- **パス**: `src/components/admin/AudioUploadModal.tsx`
- **Props**:
  - `playlistId: string` - プレイリストID
  - `onUploadComplete: () => void` - アップロード完了時のコールバック
- **説明**: 音声アップロード用モーダルダイアログ

### 再利用コンポーネント

- `PlaylistManager` (`src/components/admin/PlaylistManager.tsx`)
- `RecordingList` (`src/components/admin/RecordingList.tsx`)
- `usePlayer` (`src/hooks/usePlayer.ts`)

### 使用する主要ライブラリ

- Next.js (App Router)
- Supabase (データベース + Storage)
- Radix UI (Dialog, Select, Button, Card など)
- Tailwind CSS
- @dnd-kit (ドラッグ&ドロップ)
- Web Audio API (音声出力デバイス選択)

## 既存画面との違い

| 項目 | 既存の管理画面 | 既存のループ再生画面 | 新管理画面 (Admin v2) |
|------|---------------|-------------------|---------------------|
| URL | `/admin` | `/play` | `/admin/v2` |
| プレイリスト選択 | 一覧から詳細へ | ドロップダウン | 一覧から詳細へ |
| 再生機能 | なし | あり | あり |
| デバイス選択 | なし | あり | あり |
| ビジュアライザー | なし | 大きい (400px×100px程度) | 小さい (150px×40px) |
| 音声アップロード | 常に表示 | なし | モーダル形式 |
| 音声一覧 | あり | なし | あり |
| 統計情報 | あり | なし | なし |
| 文字起こし編集 | あり | なし | あり |
| 並び替え | あり | なし | あり |

## 実装の注意点

1. **既存コードを残す**: `/admin` と `/play` は削除せず、そのまま残す
2. **再生中の編集**: 既存のループ再生画面と同じ挙動（スナップショット方式）を維持
3. **デバイス選択の保存**: localStorageに保存し、次回起動時に復元
4. **レスポンシブ対応**: モバイルでも使いやすいUIにする
5. **エラーハンドリング**: アップロード失敗、再生エラーなどを適切に処理

## 今後の拡張可能性

- プレイリスト間の録音コピー/移動
- 再生速度の調整
- ボリューム調整
- プレイリストのインポート/エクスポート
- 複数デバイスでの同時再生

---

**作成日**: 2025-11-07
**対象バージョン**: v2
**ステータス**: 承認済み
